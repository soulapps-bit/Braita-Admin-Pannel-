<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braita | Admin Hub</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #9C27B0; --outer-bg: #212121; --card-bg: #FFFFFF; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--outer-bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        #adminPanel { display: none; width: 100%; max-width: 900px; }
        .frame { background: var(--card-bg); border-radius: 4px; overflow: hidden; min-height: 95vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .banner { background: var(--primary); color: white; padding: 25px; text-align: center; font-size: 22px; font-weight: 500; }
        .content { padding: 20px; }
        
        /* Stats & Update Control Row */
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .stats-card, .update-card { background: #F8F8F8; padding: 20px; border-radius: 4px; border: 1px solid #EEE; flex: 1; }
        .stats-card { display: flex; justify-content: space-around; align-items: center; }
        
        /* Layered Circle Stats */
        .circle-outer { width: 85px; height: 85px; border-radius: 50%; background: rgba(156, 39, 176, 0.2); display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .circle-mid { width: 75px; height: 75px; border-radius: 50%; background: rgba(156, 39, 176, 0.4); display: flex; align-items: center; justify-content: center; }
        .circle-inner { width: 65px; height: 65px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 10px; color: #666; font-weight: bold; text-align: center; }

        /* Form Container & Inputs */
        .form-container { background: #F8F8F8; padding: 25px; border-radius: 4px; position: relative; }
        .field-group { margin-bottom: 15px; text-align: left; }
        .field-label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; font-weight: 600; padding-left: 5px; }
        input { width: 100%; padding: 12px; border: 1.5px solid #E1BEE7; border-radius: 4px; background: #F3E5F5; box-sizing: border-box; font-size: 14px; }
        input:focus { outline: 2px solid #2196F3; }
        
        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-purple { background: var(--primary); width: 100%; }
        .btn-action { padding: 8px 20px; font-size: 13px; min-width: 100px; }
        .update-btns { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }

        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 300px; }

        /* Mobile Adjustments */
        @media screen and (max-width: 768px) {
            .stats-row { flex-direction: column; }
            .action-row { flex-direction: column; align-items: stretch !important; gap: 5px; }
            .btn-action { width: 100%; }
            .circle-outer { width: 75px; height: 75px; }
            .circle-inner { font-size: 16px; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--primary);">Admin Access</h2>
            <input type="password" id="adminPass" placeholder="******" style="text-align:center; letter-spacing:5px; margin-top:10px;">
            <button onclick="attemptLogin()" class="btn btn-purple" style="margin-top:20px;">Verify & Enter</button>
        </div>
    </div>

    <div id="adminPanel" class="frame">
        <div class="banner">Braita Admin Panel</div>
        <div class="content">
            
            <div class="stats-row">
                <div class="stats-card">
                    <div style="text-align:center;"><div class="circle-outer"><div class="circle-mid"><div class="circle-inner" id="valUsers">0</div></div></div><div class="stat-label">Users Count</div></div>
                    <div style="text-align:center;"><div class="circle-outer"><div class="circle-mid"><div class="circle-inner" id="valHigh">0</div></div></div><div class="stat-label">Highest Record</div></div>
                    <div style="text-align:center;"><div class="circle-outer"><div class="circle-mid"><div class="circle-inner" id="valTotal">0</div></div></div><div class="stat-label">All Quiz Count</div></div>
                </div>
                <div class="update-card">
                    <div style="color:var(--primary); font-size:12px; font-weight:bold; margin-bottom:15px;">App update control</div>
                    <input type="number" id="vNum" placeholder="Version Number">
                    <div class="update-btns">
                        <button class="btn btn-purple" onclick="updateApp(1)">Enable Update</button>
                        <button class="btn" style="background:#FF0000; width:100%;" onclick="updateApp(0)">Disable Update</button>
                    </div>
                </div>
            </div>

            <div class="form-container">
                <div class="action-row" style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 5px;">
                    <button class="btn btn-action" style="background: var(--primary);" onclick="location.href='LiveUserRanking.html'">Users List</button>
                    <button class="btn btn-action" style="background: #424242;" onclick="location.href='ManageQuizzes.html'">Edit Quiz</button>
                </div>

                <div style="text-align: right; font-size: 13px; color: #666; margin-bottom: 20px; padding-right: 5px;">
                    Last Quiz Number : <span id="lastQuizNum" style="text-decoration: underline; font-weight: bold;">Loading...</span>
                </div>

                <div style="color:var(--primary); font-size:14px; font-weight:bold; margin-bottom:20px; text-align:center;">Add New Quiz Question</div>
                
                <div class="field-group"><span class="field-label">Quiz Number</span><input type="text" id="qKey" placeholder="quizXXXXX"></div>
                <div class="field-group"><span class="field-label">Question</span><input type="text" id="qText"></div>
                <div class="field-group"><span class="field-label">Answer 1</span><input type="text" id="ans1"></div>
                <div class="field-group"><span class="field-label">Answer 2</span><input type="text" id="ans2"></div>
                <div class="field-group"><span class="field-label">Answer 3</span><input type="text" id="ans3"></div>
                <div class="field-group"><span class="field-label">Answer 4</span><input type="text" id="ans4"></div>
                <div class="field-group"><span class="field-label">Correct Answer</span><input type="text" id="correctAns"></div>
                
                <button class="btn btn-purple" onclick="uploadQuiz()">Submit Quiz</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = { 
            apiKey: "AIzaSyDOBYUY8CpTN6myiwkQYwO-dPm8Cc24MA8", 
            authDomain: "braita-cf3e7.firebaseapp.com", 
            databaseURL: "https://braita-cf3e7-default-rtdb.firebaseio.com", 
            projectId: "braita-cf3e7", 
            storageBucket: "braita-cf3e7.firebasestorage.app", 
            messagingSenderId: "180429637069", 
            appId: "1:180429637069:web:3aea1a2e89f8936457f084" 
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Device Session Persistence (24 Hour Rule)
        let adminDeviceId = localStorage.getItem('adminDeviceId') || 'br_'+Math.random().toString(36).substr(2,9);
        localStorage.setItem('adminDeviceId', adminDeviceId);

        window.onload = function() {
            database.ref('AdminSessions/'+adminDeviceId).get().then(s => {
                if(s.exists() && Date.now() - s.val().lastLogin < 86400000) showPanel();
            });
        };

        function attemptLogin() {
            const pass = document.getElementById('adminPass').value;
            database.ref('AdminLiginKey/Password').get().then(s => {
                if(s.val() === pass) {
                    database.ref('AdminSessions/'+adminDeviceId).set({lastLogin: Date.now()}).then(showPanel);
                } else { alert("Access Denied: Wrong Password"); }
            });
        }

        function showPanel() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            startDataListeners();
        }

        function startDataListeners() {
            // Stats Listeners (Users & High Score)
            database.ref('User').on('value', snap => {
                let uCount = 0, hScore = 0;
                snap.forEach(c => { uCount++; let comp = c.val().TotalCompletedQuizCount || 0; if(comp > hScore) hScore = comp; });
                document.getElementById('valUsers').innerText = uCount; 
                document.getElementById('valHigh').innerText = hScore;
            });

            // UPDATED: Last Quiz Finder & Auto-Increment Logic
            database.ref('Quizzes/Quizzes').on('value', snap => {
                const total = snap.numChildren();
                document.getElementById('valTotal').innerText = total;

                if (snap.exists()) {
                    let keys = Object.keys(snap.val());
                    keys.sort(); // Ensures quiz00190 comes after quiz00189
                    let lastKey = keys[keys.length - 1];
                    
                    // Update the "Last Quiz Number" display text
                    document.getElementById('lastQuizNum').innerText = lastKey;

                    // --- AUTO-FILL LOGIC ---
                    // 1. Remove the word "quiz" to get the number (e.g., "00190")
                    let lastNumStr = lastKey.replace('quiz', '');
                    let lastNumInt = parseInt(lastNumStr);
                    
                    // 2. Add 1 to the number (e.g., 191)
                    let nextNumInt = lastNumInt + 1;
                    
                    // 3. Format back to 'quiz00191' with 5 digits
                    let nextKey = "quiz" + nextNumInt.toString().padStart(5, '0');
                    
                    // 4. Fill the input field automatically
                    document.getElementById('qKey').value = nextKey;
                    
                } else {
                    document.getElementById('lastQuizNum').innerText = "None";
                    document.getElementById('qKey').value = "quiz00001";
                }
            });
        }

        function uploadQuiz() {
            const key = document.getElementById('qKey').value;
            if(!key.startsWith('quiz')) return alert("Error: Use 'quizXXXXX' pattern");

            const data = { 
                question: document.getElementById('qText').value, 
                correctAnswer: document.getElementById('correctAns').value, 
                answers: [
                    document.getElementById('ans1').value, 
                    document.getElementById('ans2').value, 
                    document.getElementById('ans3').value, 
                    document.getElementById('ans4').value
                ] 
            };

            database.ref('Quizzes/Quizzes/'+key).set(data).then(() => { 
                alert("Quiz " + key + " Saved Successfully!"); 
                // Clear question fields only (ID will update automatically via listener)
                ['qText','ans1','ans2','ans3','ans4','correctAns'].forEach(id => document.getElementById(id).value = "");
            });
        }

        function updateApp(status) { 
            const v = document.getElementById('vNum').value; 
            database.ref('Updates').update({ Avalable: status, Version: parseInt(v) }).then(() => alert("App Settings Updated!")); 
        }
    </script>
</body>
</html>
